# Форк сломанного репозитория https://github.com/betamaster2/youtube

>Перестало работать по причине того, что последний функционал получал данные с youtube путем парса dom, после тога как
 структура изменилась, данные стали парситься не корректно. Использовав api youtube, на текущий момент, востановлен список
 популярных видео на главном экране приложения.

## Заметки по коду которыя имеется:
1. Основная js логика находится тут `apps/magcore-app-youtube/3.0.13/js/release.js`, `apps/magcore-plugin-youtube-dl/1.1.8/index.js`  
`release.js` был деобфусцирован и тяжело читается. Там много повторяющегося кода разных версий парсирования. В идеале
зарефакторить его после того как работоспособность будет восстановлена. Первоначальная версия скопирована в
`apps/magcore-app-youtube/3.0.13/js/release_initial_state.js`
1. Логика получения списков видео, каналов располагается тут `apps/magcore-app-youtube/3.0.13/js/release.js:5866`. На
текущий момент восстановлен только основной список популярных видео, логика парса по api тут `apps/magcore-app-youtube/3.0.13/js/release.js:5919`
Необходимо по аналогии сделать пагинацию и поддержку парса списка каналов в этом же методе. Для пагинации нужно поймать
nextPageToken сохранить его как parseId и отправить его в параметре pageToken следующего запроса. Доки к youtube api:
[тут](https://developers.google.com/youtube/v3/docs)
1. На текущий момент есть проблема с запуском видео, вероятнее всего по той же причине - инфа о видео парсится из
dom который изменился. Начало логики тут `apps/magcore-plugin-youtube-dl/1.1.8/index.js:14042` и далее там множество методов
на получение необходимой информации.  
Логика запуска проигрывателя начинается тут `apps/magcore-app-youtube/3.0.13/js/release.js:3150`, на текущий момент там
выбрасывается нотификейшн "Video is not available", причина не разобрана.

## Заметки по окружению, разработки и тестированию:
1. Сэмулировать портал не получилось, приходится проверять на реальном устройстве в режиме дебага. Рекомендую развернуть стенд рядом с собой.
1. Для удобства нужно настроить IDE для работы по sftp сразу на сервере, где находится сталкер. Настройка окружения на
примере jetbrains [тут](https://github.com/atlk-kv/mag-youtube/tree/master/idea_settings_screens)
После каждого изменения необходимо перезагружать приставку после чего подтянется актуальный код.
1. Для вывода информации в дебаг нужно просто воспользоваться методом console.
1. Для того чтобы зарелизить приложение для его автоматической загрузки на сервер нужно тегировать репозиторий новой версией
(на гитхабе можно создать чз вэб интерфейс "Draft a new release" ) после чего на сталкере она будет отображается как
одна из версий для деплоя.

Вся информацию по тестовому серверу и работе с приставной есть у Данила Кононенко.

